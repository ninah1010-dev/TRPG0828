<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®äºº TRPG å†’éšª (Gemini Canvas æ–¹ä¾¿è‡ªè¨‚ç‰ˆ)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and scrollbars */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #0a0a0a; /* Dark background */
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 8px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 10px;
            border: 2px solid #2d3748;
        }
        .scrollbar-thin {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        /* Ensure containers take full height */
        #game-container > div {
            min-height: calc(100vh - 4rem); /* Adjust for header/footer if needed */
        }
        /* Custom styles for the message box */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1a202c;
            color: #e2e8f0;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        /* HP bar styles */
        #hp-bar-container {
            width: 100%;
            background-color: #4a5568;
            border-radius: 9999px;
            overflow: hidden;
        }
        #hp-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: #f56565; /* Red-500 */
        }
        .san-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: #f6ad55; /* Orange-400 */
        }
        .mp-bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
            background-color: #4299e1; /* Blue-400 */
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200">

<div id="game-container" class="flex flex-col md:flex-row h-screen">
    <!-- å·¦å´æ¬„ä½ï¼šéŠæˆ²æ—¥èªŒ -->
    <div id="story-column" class="md:w-1/2 p-4 md:p-8 flex-col h-full bg-gray-900 border-r-2 border-gray-800 hidden">
        <h1 class="text-3xl font-bold mb-4 text-center text-teal-400">å†’éšªæ—¥èªŒ</h1>
        <div id="story-log" class="flex-grow overflow-y-auto scrollbar-thin space-y-4 p-4 rounded-lg bg-gray-800 shadow-inner">
            <!-- éŠæˆ²æ•…äº‹å°‡åœ¨æ­¤è™•å‹•æ…‹æ·»åŠ  -->
        </div>
        <!-- ä¸‹è¼‰éŠæˆ²è¨˜éŒ„æŒ‰éˆ• -->
        <div class="mt-4 pt-4 border-t border-gray-700">
             <button id="download-game-state-btn" class="w-full px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                ä¸‹è¼‰éŠæˆ²è¨˜éŒ„
            </button>
        </div>
    </div>

    <!-- å³å´æ¬„ä½ï¼šè¨­å®šã€è§’è‰²å‰µå»ºæˆ–è¡Œå‹• -->
    <div class="md:w-1/2 p-4 md:p-8 flex flex-col h-full">

        <!-- Google ç™»å…¥/ç™»å‡ºæŒ‰éˆ•å·²ç§»é™¤ -->
        <div class="flex justify-end mb-4">
            <span id="user-info" class="text-gray-400 flex items-center ml-2"></span>
        </div>

        <!-- æ­¥é©Ÿ 1: åˆå§‹è¨­å®šé é¢ -->
        <div id="setup-page" class="flex-shrink-0 mb-8 p-6 rounded-xl bg-gray-800 border border-gray-700 shadow-lg">
            <h2 class="text-2xl font-semibold text-center mb-4 text-emerald-400">å†’éšªè¨­å®š</h2>

            <div class="space-y-4">
                <div class="space-y-2">
                    <label for="game-style-select" class="block text-sm font-medium">å†’éšªé¢¨æ ¼ï¼š</label>
                    <select id="game-style-select" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500">
                        <option value="å¥‡å¹»">å¥‡å¹» (Fantasy)</option>
                        <option value="ç§‘å¹»">ç§‘å¹» (Sci-Fi)</option>
                        <option value="åµæ¢">åµæ¢ (Detective)</option>
                        <option value="ææ€–">ææ€– (Horror)</option>
                        <option value="è‡ªå®šç¾©">è‡ªå®šç¾© (Custom)</option>
                    </select>
                </div>
                 <!-- è‡ªå®šç¾©é¢¨æ ¼è¼¸å…¥æ¡† -->
                <div id="custom-style-input-container" class="space-y-2 hidden">
                    <label for="custom-style-input" class="block text-sm font-medium">è‡ªå®šç¾©ä¸–ç•Œè§€ï¼š</label>
                    <input type="text" id="custom-style-input" placeholder="ä¾‹å¦‚ï¼šè³½åšé¾å…‹ã€æœ«æ—¥ç”Ÿå­˜" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500">
                </div>

                <div class="space-y-2">
                    <label for="game-turns" class="block text-sm font-medium">å›åˆæ•¸ (è‡³å°‘6):</label>
                    <input type="number" id="game-turns" min="6" value="6" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500">
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-medium">é›£åº¦è¨­å®šï¼š</label>
                    <div class="flex items-center justify-between mt-1">
                        <label class="inline-flex items-center">
                            <input type="radio" name="difficulty" value="easy" class="form-radio text-teal-500" checked>
                            <span class="ml-2">ç°¡å–®</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="difficulty" value="medium" class="form-radio text-teal-500">
                            <span class="ml-2">ä¸­ç­‰</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="difficulty" value="hard" class="form-radio text-teal-500">
                            <span class="ml-2">å›°é›£</span>
                        </label>
                    </div>
                </div>

                <button id="next-to-char-btn" class="w-full mt-4 px-4 py-2 bg-gradient-to-r from-teal-500 to-emerald-600 text-white font-bold rounded-lg shadow-lg hover:from-teal-600 hover:to-emerald-700 transition duration-300">
                    ä¸‹ä¸€æ­¥ï¼šå»ºç«‹è§’è‰²
                </button>

                <!-- éŠæˆ²è¨˜éŒ„ä¸Šå‚³åŠŸèƒ½ -->
                <div class="mt-8 pt-4 border-t border-gray-700 space-y-4">
                    <h3 class="text-lg font-bold text-gray-300 mb-2">éŠæˆ²è¨˜éŒ„ç®¡ç†</h3>
                    <div class="flex space-x-4">
                        <input type="file" id="upload-game-state" accept=".json" class="hidden">
                        <button id="upload-game-state-btn" class="flex-1 px-4 py-2 bg-yellow-600 text-white font-bold rounded-lg shadow-md hover:bg-yellow-700 transition duration-300">
                            ä¸Šå‚³éŠæˆ²è¨˜éŒ„
                        </button>
                    </div>
                    <!-- Google Drive ç´€éŒ„ç›¸é—œæŒ‰éˆ•èˆ‡åˆ—è¡¨å·²ç§»é™¤ -->
                    <div id="drive-saves-list" class="mt-4 p-4 bg-gray-700 rounded-lg hidden">
                        <h4 class="text-md font-bold text-gray-300 mb-2">Google Drive å·²å„²å­˜çš„ç´€éŒ„:</h4>
                        <div id="drive-saves-container" class="space-y-2">
                            <p class="text-gray-400 text-center">Google Drive å„²å­˜åŠŸèƒ½å·²ç§»é™¤ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 2: è§’è‰²å‰µå»ºé é¢ -->
        <div id="character-creation-page" class="flex-shrink-0 mb-8 p-6 rounded-xl bg-gray-800 border border-gray-700 shadow-lg hidden">
            <h2 class="text-2xl font-semibold text-center mb-4 text-emerald-400">å»ºç«‹ä½ çš„è§’è‰²</h2>
            <div id="char-creation-content" class="space-y-4">
                 <!-- è§’è‰²è³‡è¨Šè¼¸å…¥æ¡† -->
                <div class="space-y-2">
                    <label for="char-name" class="block text-sm font-medium">è§’è‰²åç¨±ï¼š</label>
                    <input type="text" id="char-name" placeholder="æ­£åœ¨ç”Ÿæˆåç¨±..." class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500">
                </div>
                <div class="space-y-2">
                    <label for="char-background" class="block text-sm font-medium">èƒŒæ™¯æ•…äº‹ï¼š</label>
                    <textarea id="char-background" rows="4" placeholder="æ­£åœ¨ç”ŸæˆèƒŒæ™¯æ•…äº‹..." class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
                 <div class="space-y-2">
                    <label for="char-ability-input" class="block text-sm font-medium">ç‰¹æ®Šèƒ½åŠ›èˆ‡è§¸ç™¼æ¢ä»¶ï¼š</label>
                    <textarea id="char-ability-input" rows="3" placeholder="ç¯„ä¾‹ï¼š[å¤©ç”Ÿç¥åŠ›]: é©ç”¨æ–¼åŠ›é‡æª¢å®šï¼Œæ“²éª° D20ï¼Œçµæœ 18-20 æ™‚è§¸ç™¼ã€‚æ•ˆæœï¼šæˆåŠŸé›£åº¦é™ä½ 5ã€‚" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500"></textarea>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-medium">å±¬æ€§é»æ•¸åˆ†é… (ç¸½é»æ•¸ <span id="max-points-display">10</span>)ï¼š</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex items-center space-x-2">
                            <label for="char-str" class="text-sm font-semibold text-yellow-400 w-16">åŠ›é‡(STR)</label>
                            <input type="number" id="char-str" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="char-dex" class="text-sm font-semibold text-blue-400 w-16">æ•æ·(DEX)</label>
                            <input type="number" id="char-dex" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="char-int" class="text-sm font-semibold text-purple-400 w-16">æ™ºåŠ›(INT)</label>
                            <input type="number" id="char-int" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="char-con" class="text-sm font-semibold text-green-400 w-16">é«”åŠ›(CON)</label>
                            <input type="number" id="char-con" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="char-san" class="text-sm font-semibold text-orange-400 w-16">ç†æ™º(SAN)</label>
                            <input type="number" id="char-san" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="char-cha" class="text-sm font-semibold text-pink-400 w-16">é­…åŠ›(CHA)</label>
                            <input type="number" id="char-cha" min="1" max="10" value="0" class="w-20 rounded-md bg-gray-700 border-gray-600 shadow-sm p-1 text-gray-200 text-center">
                        </div>
                    </div>
                    <p id="points-left" class="text-right text-sm font-bold text-gray-400">å‰©é¤˜é»æ•¸: 10</p>
                </div>
            </div>
            <button id="start-game-btn" class="w-full mt-4 px-4 py-2 bg-gradient-to-r from-teal-500 to-emerald-600 text-white font-bold rounded-lg shadow-lg hover:from-teal-600 hover:to-emerald-700 transition duration-300">
                é–‹å§‹å†’éšªï¼
            </button>
        </div>

        <!-- æ­¥é©Ÿ 3: éŠæˆ²é é¢ -->
        <div id="game-page" class="flex-shrink-0 mb-8 p-6 rounded-xl bg-gray-800 border border-gray-700 shadow-lg hidden">
            <div id="character-sheet" class="flex-shrink-0 mb-8 p-6 rounded-xl bg-gray-800 border border-gray-700 shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-center text-emerald-400">è§’è‰²ç‹€æ…‹</h2>
                <div class="space-y-2 mb-4">
                    <p id="display-name" class="text-xl font-bold text-teal-300">å§“å: </p>
                    <p id="display-style" class="text-md text-gray-400">é¢¨æ ¼: </p>
                    <p id="display-current-turn" class="text-md text-gray-400">ç•¶å‰å›åˆ: </p>
                </div>
                 <!-- HP é€²åº¦æ¢ -->
                <div class="mb-4">
                    <label for="hp-bar" class="block text-md font-medium text-red-400">HP: <span id="display-hp-value"></span></label>
                    <div id="hp-bar-container" class="w-full h-4 relative mt-1">
                        <div id="hp-bar" class="bg-red-500 absolute h-full rounded-full transition-all duration-500 ease-in-out" style="width: 100%;"></div>
                    </div>
                </div>
                 <!-- å±¬æ€§é¡¯ç¤º (å€¼èˆ‡æ‹¬è™Ÿ) -->
                <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <span class="block text-xl font-bold text-yellow-400">åŠ›é‡</span>
                        <span class="text-lg font-bold" id="display-str-value"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-blue-400">æ•æ·</span>
                        <span class="text-lg font-bold" id="display-dex-value"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-purple-400">æ™ºåŠ›</span>
                        <span class="text-lg font-bold" id="display-int-value"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-green-400">é«”åŠ›</span>
                        <span class="text-lg font-bold" id="display-con-value"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-orange-400">ç†æ™º</span>
                        <span class="text-lg font-bold" id="display-san-value"></span>
                    </div>
                    <div class="text-center">
                        <span class="block text-xl font-bold text-pink-400">é­…åŠ›</span>
                        <span class="text-lg font-bold" id="display-cha-value"></span>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-bold text-gray-300 mb-2">èƒŒæ™¯æ•…äº‹</h3>
                    <div id="display-background" class="rounded-xl p-4 bg-gray-700 border border-gray-600 shadow-lg text-sm text-gray-300"></div>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-bold text-gray-300 mb-2">ç‰¹æ®Šèƒ½åŠ›</h3>
                    <!-- ç‰¹æ®Šèƒ½åŠ›é¡¯ç¤ºå’ŒæŒ‰éˆ•å€å¡Š -->
                    <div id="display-ability-container" class="rounded-xl p-4 bg-gray-700 border border-gray-600 shadow-lg text-sm text-gray-300">
                        <div id="display-ability-text"></div>
                        <button id="use-ability-btn" class="w-full mt-3 px-4 py-2 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                            ä½¿ç”¨ç‰¹æ®Šèƒ½åŠ›
                        </button>
                        <p id="ability-cooldown-display" class="text-center text-xs text-gray-400 mt-2"></p>
                    </div>
                </div>
            </div>

            <div id="game-controls" class="flex-grow flex flex-col justify-end p-6 rounded-xl bg-gray-800 border border-gray-700 shadow-lg">
                <div id="action-prompt" class="mb-4 text-lg text-center text-gray-300">
                    <!-- è¡Œå‹•æç¤ºå°‡åœ¨æ­¤è™•é¡¯ç¤º -->
                </div>
                <!-- AI ç”Ÿæˆçš„è¡Œå‹•é¸é …å®¹å™¨ -->
                <div id="ai-action-options-container" class="flex flex-col space-y-4">
                    <!-- AI ç”Ÿæˆçš„è¡Œå‹•é¸é …å°‡åœ¨æ­¤è™•å‹•æ…‹æ·»åŠ  -->
                </div>

                <!-- é è¨­è¡Œå‹•æŒ‰éˆ• (åƒ…åœ¨AIæœªæä¾›é¸é …æ™‚é¡¯ç¤º) -->
                <div id="default-actions-group" class="mt-8 pt-4 border-t border-gray-700 hidden">
                    <h3 class="text-lg font-bold text-gray-300 mb-4 text-center">é è¨­è¡Œå‹•</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button id="default-action-forward" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300">
                            æŒçºŒå‰é€²
                        </button>
                        <button id="default-action-observe" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300">
                            è§€å¯Ÿæƒ…æ³
                        </button>
                        <button id="default-action-rest" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition duration-300">
                            åŸåœ°ä¼‘æ¯
                        </button>
                    </div>
                </div>

                <!-- è‡ªè¨‚è¡Œå‹•å€å¡Š (ç¸½æ˜¯é¡¯ç¤º) -->
                <div id="custom-action-group" class="mt-8 pt-4 border-t border-gray-700">
                    <h3 class="text-lg font-bold text-gray-300 mb-4 text-center">è‡ªè¨‚è¡Œå‹•</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="custom-action-text" class="block text-sm font-medium">è¡Œå‹•æè¿°ï¼š</label>
                            <textarea id="custom-action-text" rows="2" placeholder="ä¾‹å¦‚ï¼šå˜—è©¦ç”¨ç¹©ç´¢çˆ¬ä¸Šæ‡¸å´–" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500"></textarea>
                            <p id="ai-attribute-suggestion" class="text-xs text-gray-400 mt-1">AI å»ºè­°å±¬æ€§: å¾…åˆ†æ</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="custom-action-dice" class="block text-sm font-medium">ä½¿ç”¨éª°å­ï¼š</label>
                                <select id="custom-action-dice" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 focus:ring-teal-500 focus:border-teal-500">
                                    <option value="d6">D6</option>
                                    <option value="d10">D10</option>
                                    <option value="d20">D20</option>
                                    <option value="d30">D30</option>
                                    <option value="d60">D60</option>
                                    <option value="d100">D100</option>
                                </select>
                            </div>
                            <div>
                                <label for="custom-action-difficulty" class="block text-sm font-medium">è¡Œå‹•é›£åº¦ï¼š</label>
                                <!-- max å±¬æ€§å°‡ç”± JavaScript å‹•æ…‹è¨­å®š -->
                                <input type="number" id="custom-action-difficulty" min="1" value="5" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 shadow-sm p-2 text-gray-200 text-center focus:ring-teal-500 focus:border-teal-500">
                            </div>
                        </div>
                        <button id="execute-custom-action-btn" class="w-full px-4 py-2 bg-purple-600 text-white font-bold rounded-lg shadow-md hover:bg-purple-700 transition duration-300">
                            åŸ·è¡Œè‡ªè¨‚è¡Œå‹•
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google API ç›¸é—œçš„ script å·²ç§»é™¤ -->

<script type="module">
    const GOOGLE_APP_NAME = 'TRPG_Game_Gemini_Canvas'; // æ­¤å¸¸æ•¸ä¸å†ä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€

    const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=";

    const GAME_STATE_FILENAME = 'trpg_game_state.json';

    let gameState = {
        geminiApiKey: "AIzaSyCEIsgA8IDtFfJX1sNNv48xnm1TTYKInm4", // Embedded API key
        name: "",
        background: "",
        ability: "",
        style: "",
        hp: 50,
        maxHp: 50,
        str: 0,
        dex: 0,
        int: 0,
        con: 0,
        san: 0,
        cha: 0,
        storyLog: [],
        currentEvent: null,
        loadingStory: false,
        gameLength: 6,
        currentTurn: 1, 
        difficulty: "medium",
        aiSuggestedCustomSkill: null,
        abilityCooldown: 0, // æ–°å¢: ç‰¹æ®Šèƒ½åŠ›å†·å»æ™‚é–“
        abilityMaxCooldown: 3, // æ–°å¢: ç‰¹æ®Šèƒ½åŠ›æœ€å¤§å†·å»æ™‚é–“ (ä¾‹å¦‚ 3 å›åˆ)
        nextActionDifficultyReduction: 0 // æ–°å¢: ä¸‹æ¬¡è¡Œå‹•çš„é›£åº¦æ¸›å…
    };
    
    const statInputs = ['char-str', 'char-dex', 'char-int', 'char-con', 'char-san', 'char-cha'];
    const totalPoints = 10; // Modified: ç¸½å±¬æ€§é»æ•¸ç‚º 10
    const attributeMapping = { // ç”¨æ–¼å±¬æ€§åç¨±é¡¯ç¤º
        str: 'åŠ›é‡',
        dex: 'æ•æ·',
        int: 'æ™ºåŠ›',
        con: 'é«”åŠ›',
        san: 'ç†æ™º',
        cha: 'é­…åŠ›'
    };

    // Define dice map globally within the module script
    const diceMap = {
        'd6': 6, 'd10': 10, 'd20': 20, 'd30': 30, 'd60': 60, 'd100': 100
    };

    // Declare elements globally as an empty object. It will be populated in window.onload.
    let elements = {};

    // Google API ç›¸é—œçš„åˆå§‹åŒ–å‡½æ•¸å·²ç§»é™¤


    function showMessage(message, type = 'info') {
        const existingMessageBox = document.querySelector('.message-box');
        if (existingMessageBox) {
            existingMessageBox.remove();
        }

        const messageBox = document.createElement('div');
        messageBox.className = `message-box p-4 rounded-lg shadow-xl border ${type === 'error' ? 'bg-red-900 border-red-700' : 'bg-gray-800 border-gray-700'} text-gray-200 max-w-sm text-center`;
        messageBox.innerHTML = `
            <p>${message}</p>
            <button class="mt-4 px-4 py-2 bg-teal-600 rounded-md hover:bg-teal-700 transition duration-200">é—œé–‰</button>
        `;
        document.body.appendChild(messageBox);
        
        messageBox.querySelector('button').addEventListener('click', () => {
            messageBox.remove();
        });
    }

    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Google ç™»å…¥/ç™»å‡ºå’Œ Drive ç›¸é—œåŠŸèƒ½å·²ç§»é™¤


    // --- Game Logic ---
    function showSetupPage() {
        elements.setupPage.classList.remove('hidden');
        elements.characterCreationPage.classList.add('hidden');
        elements.gamePage.classList.add('hidden');
        elements.storyColumn.classList.add('hidden');
    }

    function showCharacterCreationPage() {
        elements.setupPage.classList.add('hidden');
        elements.characterCreationPage.classList.remove('hidden');
        elements.gamePage.classList.add('hidden');
        elements.storyColumn.classList.add('hidden');
    }

    function showGamePage() {
        elements.setupPage.classList.add('hidden');
        elements.characterCreationPage.classList.add('hidden');
        elements.gamePage.classList.remove('hidden');
        elements.storyColumn.classList.remove('hidden');
    }
    
    function renderCharacterSheet() {
        if (!elements.gamePage) return;
        elements.displayName.textContent = `å§“å: ${gameState.name}`;
        elements.displayStyle.textContent = `é¢¨æ ¼: ${gameState.style}`;
        
        elements.displayHpValue.textContent = `${gameState.hp} / ${gameState.maxHp}`;
        const hpPercentage = (gameState.hp / gameState.maxHp) * 100;
        elements.hpBar.style.width = `${hpPercentage}%`;

        elements.displayStrValue.textContent = `${gameState.str} (+0)`;
        elements.displayDexValue.textContent = `${gameState.dex} (+0)`;
        elements.displayIntValue.textContent = `${gameState.int} (+0)`;
        elements.displayConValue.textContent = `${gameState.con} (+0)`;
        elements.displaySanValue.textContent = `${gameState.san} (+0)`;
        elements.displayChaValue.textContent = `${gameState.cha} (+0)`;

        elements.displayCurrentTurn.textContent = `ç•¶å‰å›åˆ: ${gameState.currentTurn} / ${gameState.gameLength}`;
        if (elements.displayBackground) elements.displayBackground.textContent = gameState.background;

        // ç‰¹æ®Šèƒ½åŠ›é¡¯ç¤º
        if (elements.displayAbilityText) elements.displayAbilityText.textContent = gameState.ability;

        if (elements.useAbilityBtn) {
            if (gameState.abilityCooldown > 0) {
                elements.useAbilityBtn.disabled = true;
                elements.useAbilityBtn.textContent = `èƒ½åŠ›å†·å»ä¸­ (${gameState.abilityCooldown} å›åˆ)`;
                elements.abilityCooldownDisplay.textContent = `ä¸‹æ¬¡å¯ç”¨: ${gameState.abilityCooldown} å›åˆå¾Œ`;
            } else {
                elements.useAbilityBtn.disabled = false;
                elements.useAbilityBtn.textContent = 'ä½¿ç”¨ç‰¹æ®Šèƒ½åŠ›';
                elements.abilityCooldownDisplay.textContent = 'èƒ½åŠ›å·²å°±ç·’';
            }
            if (gameState.hp <= 0) { // è§’è‰²æ­»äº¡æ™‚ç¦ç”¨èƒ½åŠ›
                elements.useAbilityBtn.disabled = true;
                elements.useAbilityBtn.textContent = 'ç„¡æ³•ä½¿ç”¨èƒ½åŠ› (è§’è‰²å·²æ­»äº¡)';
            }
        }
    }

    function renderStoryLog() {
        if (!elements.storyLog) return;
        elements.storyLog.innerHTML = '';
        gameState.storyLog.forEach(entry => {
            const div = document.createElement('div');
            let contentHtml = '';
            if (entry.type === 'narration') {
                contentHtml = `<p class="text-sm italic text-gray-400">${entry.content}</p>`;
            } else if (entry.type === 'event') {
                contentHtml = `<div class="bg-gray-700 p-4 rounded-lg shadow-md"><p class="text-lg font-medium">${entry.content}</p></div>`;
            } else if (entry.type === 'action') {
                contentHtml = `<p class="text-sm font-semibold text-teal-400">ä½ é¸æ“‡äº†: ${entry.content}</p>`;
            } else if (entry.type === 'roll') {
                contentHtml = `<p class="text-sm text-yellow-300">ğŸ² æ“²éª°çµæœ: ${entry.content}</p>`;
            } else if (entry.type === 'result') {
                let textColorClass = '';
                if (entry.isCriticalSuccess) {
                    textColorClass = 'text-emerald-500'; // æ·±ç¶ è‰² for Critical Success
                } else if (entry.success) {
                    textColorClass = 'text-green-400'; // ç¶ è‰² for Success
                } else if (entry.isCriticalFailure) {
                    textColorClass = 'text-red-700'; // æ·±ç´…è‰² for Critical Failure
                } else {
                    textColorClass = 'text-red-400'; // ç´…è‰² for Failure
                }
                contentHtml = `<p class="text-sm ${textColorClass}">${entry.content}</p>`;
            } else if (entry.type === 'ability_use') { // æ–°å¢èƒ½åŠ›ä½¿ç”¨æ—¥èªŒé¡å‹
                contentHtml = `<div class="bg-blue-800 p-3 rounded-lg shadow-md"><p class="text-sm text-white font-bold">âœ¨ ç‰¹æ®Šèƒ½åŠ›ä½¿ç”¨: ${entry.content}</p></div>`;
            }
            div.innerHTML = contentHtml;
            elements.storyLog.appendChild(div);
        });
        // Add loading animation if story is being generated
        if (gameState.loadingStory) {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-center p-4';
            loadingDiv.innerHTML = `
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-500 mx-auto mb-2"></div>
                <p class="text-indigo-400">æ•…äº‹ç”Ÿæˆä¸­...</p>
            `;
            elements.storyLog.appendChild(loadingDiv);
        }

        elements.storyLog.scrollTop = elements.storyLog.scrollHeight;
    }

    function renderActionOptions() {
        if (!elements.aiActionOptionsContainer || !elements.defaultActionsGroup || !elements.customActionGroup) return;

        elements.aiActionOptionsContainer.innerHTML = ''; // æ¸…ç©º AI ç”Ÿæˆé¸é …

        // Only show options if not loading story
        if (gameState.loadingStory) {
            elements.actionPrompt.textContent = "è™•ç†ä¸­...";
            elements.defaultActionsGroup.classList.add('hidden');
            elements.customActionGroup.classList.add('hidden'); // Hide custom actions during loading
            return;
        }

        const aiProvidedOptions = gameState.currentEvent && gameState.currentEvent.options && gameState.currentEvent.options.length > 0;

        if (aiProvidedOptions) {
            elements.actionPrompt.textContent = "é¸æ“‡ä½ çš„è¡Œå‹•:";
            // æ’ç‰ˆç‚ºæ©«å¼ï¼Œä¸€æ©«æ’ä¸€å€‹é¸æ“‡
            gameState.currentEvent.options.forEach(option => {
                const button = document.createElement('button');
                const difficultyText = option.difficulty ? ` (é›£åº¦: ${option.difficulty})` : '';
                const diceText = option.diceType ? ` [${option.diceType}]` : '';
                button.textContent = `${option.text}${difficultyText}${diceText}`;
                button.className = "w-full px-4 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition duration-300"; // Full width for each option
                button.addEventListener('click', () => handleAction(option));
                elements.aiActionOptionsContainer.appendChild(button);
            });
            // AI æœ‰æä¾›è¡Œå‹•æ™‚ï¼Œé è¨­è¡Œå‹•éš±è—
            elements.defaultActionsGroup.classList.add('hidden');
            // è‡ªè¨‚è¡Œå‹•å€å¡Šå§‹çµ‚é¡¯ç¤º
            elements.customActionGroup.classList.remove('hidden'); 
        } else {
            elements.actionPrompt.textContent = "AI å°šæœªæä¾›è¡Œå‹•ï¼Œè«‹é¸æ“‡é è¨­è¡Œå‹•æˆ–è‡ªè¨‚è¡Œå‹•ã€‚";
            // AI æœªæä¾›è¡Œå‹•æ™‚ï¼Œé è¨­è¡Œå‹•å’Œè‡ªè¨‚è¡Œå‹•å¿…é ˆé¡¯ç¤º
            elements.defaultActionsGroup.classList.remove('hidden'); 
            elements.customActionGroup.classList.remove('hidden');
        }
    }
    
    function addStoryEntry(entry) {
        gameState.storyLog.push(entry);
        renderStoryLog();
    }

    function rollDice(diceType) {
        let result = 0;
        const maxRoll = diceMap[diceType.toLowerCase()];
        if (maxRoll) {
            result = Math.floor(Math.random() * maxRoll) + 1;
        } else {
            result = 1; // Default to 1 if diceType is invalid
        }
        return result;
    }
    
    function checkGameOver() {
        if (gameState.hp <= 0) {
            addStoryEntry({ type: "narration", content: "ä½ çš„ç”Ÿå‘½å€¼æ­¸é›¶äº†ã€‚é€™æ˜¯ä½ çš„å†’éšªçµ‚é»ã€‚" });
            endGame();
            return true;
        }
        return false;
    }

    function endGame() {
        gameState.currentEvent = null;
        renderActionOptions(); 
        showMessage("éŠæˆ²çµæŸã€‚ä½ çš„å†’éšªå·²ç¶“åŠƒä¸‹å¥é»ã€‚é‡æ–°æ•´ç†é é¢ä»¥é–‹å§‹æ–°çš„éŠæˆ²ã€‚");
    }

    // å°‡ parseAbilityTrigger èª¿æ•´ç‚ºæ›´é€šç”¨çš„è§£æå™¨ï¼Œç”¨æ–¼å¾èƒ½åŠ›æ–‡æœ¬ä¸­æå–æ¢ä»¶å’Œæ•ˆæœ
    function parseAbilityTextForActivation(abilityText) {
        // Regex to extract ability name, applicable check, dice type, roll range, and effect
        const regex = /\[([^\]]+)\]:\s*é©ç”¨æ–¼([^ï¼Œ]+)æª¢å®šï¼Œæ“²éª°\s*(D\d+)ï¼Œçµæœ\s*(\d+(?:-\d+)?)\s*æ™‚è§¸ç™¼ã€‚æ•ˆæœï¼š(.+)/;
        const match = abilityText.match(regex);

        if (!match) {
            console.warn("æœªèƒ½è§£æç‰¹æ®Šèƒ½åŠ›æ–‡æœ¬ï¼š", abilityText);
            return null;
        }

        const [, abilityName, applicableCheck, diceType, rollRangeStr, effect] = match;
        const rollRange = rollRangeStr.includes('-')
            ? rollRangeStr.split('-').map(Number)
            : [Number(rollRangeStr), Number(rollRangeStr)];

        return {
            name: abilityName,
            applicableCheck: applicableCheck.trim(),
            diceType: diceType.trim().toLowerCase(),
            rollRange: rollRange,
            effect: effect.trim()
        };
    }


    async function handleAction(option) {
        if (gameState.loadingStory || gameState.hp <= 0) return;

        addStoryEntry({ type: "action", content: option.text });
        
        if (option.action === 'suicide_end_game') {
            addStoryEntry({ type: "narration", content: "ä½ é¸æ“‡äº†ä¸€å€‹é­¯è½ä¸”è‡´å‘½çš„è¡Œå‹•ã€‚ä½ çš„å†’éšªåœ¨éœ‡é©šçš„çµå±€ä¸­çµæŸäº†ã€‚" });
            endGame();
            return;
        }
        
        if (option.damageRoll) {
            const damage = rollDice(option.damageRoll);
            gameState.hp -= damage;
            addStoryEntry({ type: "narration", content: `ä½ å—åˆ° ${damage} é»å‚·å®³ã€‚` });
            if (checkGameOver()) return;
        }

        gameState.loadingStory = true;
        elements.actionPrompt.textContent = "è™•ç†ä¸­...";
        renderActionOptions(); 
        renderStoryLog(); // Update story log with loading animation

        const difficultyModifiers = {
            "easy": -2,
            "medium": 0,
            "hard": 2
        };

        let adjustedDifficulty = (option.difficulty || 0) + (difficultyModifiers[gameState.difficulty] || 0);
        
        // æ‡‰ç”¨ç‰¹æ®Šèƒ½åŠ›å¸¶ä¾†çš„é›£åº¦æ¸›å…
        if (gameState.nextActionDifficultyReduction > 0) {
            addStoryEntry({ type: "narration", content: `å› ç‰¹æ®Šèƒ½åŠ›æ•ˆæœï¼Œæœ¬æ¬¡è¡Œå‹•é›£åº¦é™ä½ ${gameState.nextActionDifficultyReduction} é»ã€‚` });
            adjustedDifficulty -= gameState.nextActionDifficultyReduction;
            gameState.nextActionDifficultyReduction = 0; // ä½¿ç”¨å¾Œé‡ç½®
        }

        let success = false;
        let isCriticalSuccess = false;
        let isCriticalFailure = false;

        let skill = 0;
        let skillName = '';
        let bonusFromAbility = 0; 

        if (option.diceType) {
            const rollResult = rollDice(option.diceType);

            // èª¿æ•´å¾Œçš„ parseAbilityTrigger ä¸å†ç”±é€™è£¡ç›´æ¥èª¿ç”¨ï¼Œå› ç‚ºèƒ½åŠ›æ˜¯ä¸»å‹•ä½¿ç”¨çš„
            // ä½†å¦‚æœèƒ½åŠ›æ–‡æœ¬ä¸­åŒ…å«é©ç”¨æ–¼"ä»»ä½•"æª¢å®šä¸”ç¬¦åˆç‰¹å®šæ“²éª°çµæœçš„è¢«å‹•æ•ˆæœï¼Œå‰‡éœ€è¦å¦è¡Œè™•ç†
            // ç›®å‰å‡è¨­èƒ½åŠ›æ˜¯ä¸»å‹•ä½¿ç”¨çš„æ•ˆæœ (ä¾‹å¦‚ä¸‹ä¸€å›åˆé›£åº¦æ¸›å…)

            if (option.skill) {
                skill = gameState[option.skill] || 0;
                skillName = attributeMapping[option.skill]; 
            }
            const totalRoll = rollResult + skill + bonusFromAbility;

            addStoryEntry({ type: "roll", content: `${rollResult} (æ“²éª°) + ${skillName ? skillName + ' ' : ''}å±¬æ€§ ${skill} + èƒ½åŠ›åŠ æˆ ${bonusFromAbility} = ${totalRoll} vs é›£åº¦ ${adjustedDifficulty}` });

            // åˆ¤æ–·æˆåŠŸèˆ‡å¤§æˆåŠŸ/å¤§å¤±æ•—
            const criticalThreshold = 3; // å¯èª¿æ•´çš„å¤§æˆåŠŸ/å¤§å¤±æ•—é–¾å€¼ (ä¾‹å¦‚: ç¸½å’Œè¶…éé›£åº¦3é»ç‚ºå¤§æˆåŠŸ)
            if (totalRoll >= adjustedDifficulty) {
                success = true;
                if (totalRoll >= adjustedDifficulty + criticalThreshold) { 
                    isCriticalSuccess = true;
                }
            } else {
                success = false;
                if (totalRoll <= adjustedDifficulty - criticalThreshold) { 
                    isCriticalFailure = true;
                }
            }

            let resultText = '';
            if (isCriticalSuccess) {
                resultText = `ä½ å¤§æˆåŠŸäº†ï¼æ•ˆæœé©šäººï¼`;
            } else if (success) {
                resultText = `ä½ æˆåŠŸäº†ï¼`;
            } else if (isCriticalFailure) {
                resultText = `ä½ å¤§å¤±æ•—äº†ï¼å¾Œæœåš´é‡ï¼`;
            } else {
                resultText = `ä½ å¤±æ•—äº†ã€‚`;
            }

            addStoryEntry({
                type: "result",
                content: resultText,
                success: success,
                isCriticalSuccess: isCriticalSuccess,
                isCriticalFailure: isCriticalFailure
            });
        }
        
        gameState.currentTurn++;
        // åœ¨æ–°å›åˆé–‹å§‹æ™‚æ¸›å°‘èƒ½åŠ›å†·å»
        if (gameState.abilityCooldown > 0) {
            gameState.abilityCooldown--;
        }
        renderCharacterSheet();

        await generateNextStory(option.text, success);

        gameState.loadingStory = false;
        renderActionOptions(); 
        renderStoryLog();
    }


    async function handleAbilityUse() {
        if (!elements.useAbilityBtn || elements.useAbilityBtn.disabled || gameState.loadingStory || gameState.hp <= 0) {
            showMessage("ç‰¹æ®Šèƒ½åŠ›ç›®å‰ç„¡æ³•ä½¿ç”¨ã€‚", 'info');
            return;
        }

        if (gameState.abilityCooldown > 0) {
            showMessage(`ç‰¹æ®Šèƒ½åŠ›å°šåœ¨å†·å»ä¸­ï¼Œé‚„æœ‰ ${gameState.abilityCooldown} å›åˆã€‚`, 'info');
            return;
        }

        const abilityDetails = parseAbilityTextForActivation(gameState.ability);
        if (!abilityDetails) {
            showMessage("ç‰¹æ®Šèƒ½åŠ›æè¿°è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ ¼å¼ã€‚", 'error');
            return;
        }

        addStoryEntry({ type: "ability_use", content: `${abilityDetails.name} (å˜—è©¦ç™¼å‹•)` });

        // æ¨¡æ“¬èƒ½åŠ›ç™¼å‹•çš„æ“²éª°
        const rollResult = rollDice(abilityDetails.diceType);
        addStoryEntry({ type: "roll", content: `ç™¼å‹•èƒ½åŠ›æ“²éª°: ${rollResult} (ç›®æ¨™ç¯„åœ: ${abilityDetails.rollRange[0]}-${abilityDetails.rollRange[1]})` });

        let abilityActivated = false;
        if (rollResult >= abilityDetails.rollRange[0] && rollResult <= abilityDetails.rollRange[1]) {
            abilityActivated = true;
            addStoryEntry({ type: "narration", content: `ä½ çš„ç‰¹æ®Šèƒ½åŠ› [${abilityDetails.name}] æˆåŠŸè§¸ç™¼ï¼` });
            
            // æ‡‰ç”¨èƒ½åŠ›æ•ˆæœ
            const difficultyReductionMatch = abilityDetails.effect.match(/é›£åº¦é™ä½ (\d+) é»/);
            if (difficultyReductionMatch) {
                const reductionAmount = parseInt(difficultyReductionMatch[1], 10);
                gameState.nextActionDifficultyReduction = reductionAmount;
                addStoryEntry({ type: "narration", content: `æ•ˆæœï¼šä¸‹ä¸€æ¬¡è¡Œå‹•çš„é›£åº¦å°‡é™ä½ ${reductionAmount} é»ã€‚` });
            } else {
                addStoryEntry({ type: "narration", content: `èƒ½åŠ›æ•ˆæœï¼š${abilityDetails.effect}` });
                // å¦‚æœæœ‰å…¶ä»–é¡å‹çš„å³æ™‚æ•ˆæœï¼Œå¯ä»¥åœ¨é€™è£¡æ·»åŠ è™•ç†é‚è¼¯
                // ä¾‹å¦‚: æ¢å¾© HP, å°æ•µäººé€ æˆå‚·å®³ç­‰ã€‚ç›®å‰åªè™•ç†é›£åº¦é™ä½ã€‚
            }
        } else {
            addStoryEntry({ type: "narration", content: `ç‰¹æ®Šèƒ½åŠ› [${abilityDetails.name}] æœªèƒ½è§¸ç™¼ã€‚` });
        }

        // è¨­å®šå†·å»æ™‚é–“
        gameState.abilityCooldown = gameState.abilityMaxCooldown;
        addStoryEntry({ type: "narration", content: `ç‰¹æ®Šèƒ½åŠ› [${abilityDetails.name}] é€²å…¥ ${gameState.abilityMaxCooldown} å›åˆå†·å»ã€‚` });
        
        gameState.currentTurn++; // ä½¿ç”¨èƒ½åŠ›ä¹Ÿç®—ä¸€å€‹å›åˆ
        // åœ¨æ–°å›åˆé–‹å§‹æ™‚æ¸›å°‘èƒ½åŠ›å†·å» (é€™è£¡æœƒå³æ™‚æ¸›å°‘ä¸€æ¬¡ï¼Œå› ç‚ºæ˜¯åŒä¸€å›åˆå…§)
        if (gameState.abilityCooldown > 0) {
            gameState.abilityCooldown--;
        }

        renderCharacterSheet();
        renderStoryLog();
        renderActionOptions(); // åˆ·æ–°è¡Œå‹•é¸é …ï¼Œå› ç‚ºå›åˆæ•¸å¯èƒ½å¢åŠ äº†
    }


    async function callGeminiApi(prompt) {
        let retries = 0;
        const maxRetries = 3;
        const delay = (ms) => new Promise(res => setTimeout(res, ms));

        // Use the embedded API key
        const currentApiKey = gameState.geminiApiKey; 
        if (!currentApiKey || currentApiKey === 'YOUR_GEMINI_API_KEY') { // Also check for default placeholder
            console.error("Gemini API é‡‘é‘°éºå¤±æˆ–æœªè¨­å®šã€‚è«‹ç¢ºèªå·²åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šé‡‘é‘°ã€‚");
            showMessage("Gemini API é‡‘é‘°éºå¤±æˆ–æœªè¨­å®šã€‚è«‹ç¢ºèªå·²åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šé‡‘é‘°ã€‚", 'error');
            throw new Error("Gemini API é‡‘é‘°éºå¤±ã€‚");
        }

        while (retries < maxRetries) {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{
                            text: `ä½ æ˜¯ä¸€å€‹å–®äºº TRPG éŠæˆ²çš„ä¸»æŒäºº (Game Master)ã€‚
                            ä½ çš„ä»»å‹™æ˜¯æ ¹æ“šç©å®¶çš„é¸æ“‡ï¼Œç”¢ç”Ÿä¸€æ®µç°¡æ½”çš„æ•…äº‹æ•˜è¿°ï¼Œä¸¦æä¾› 2-3 å€‹æ–°çš„è¡Œå‹•é¸é …ã€‚
                            ä½ çš„å›ç­”å¿…é ˆæ˜¯å–®ä¸€çš„ JSON ç‰©ä»¶ï¼Œæ ¼å¼ç‚º:
                            {
                                "narrative": "ç°¡çŸ­çš„æ•…äº‹æ•˜è¿°ï¼Œä¸è¶…é 200 å€‹ä¸­æ–‡å­—ã€‚",
                                "options": [
                                    {
                                        "text": "é¸é …çš„ç°¡çŸ­æè¿°ï¼Œä¾‹å¦‚'ä½¿ç”¨åŠæ”»æ“Š'",
                                        "action": "è¡Œå‹•çš„å…§éƒ¨ä»£è™Ÿï¼Œä¾‹å¦‚'attack_sword'",
                                        "difficulty": 8, // è©²è¡Œå‹•çš„é›£åº¦å€¼ï¼Œç¯„åœå–æ±ºæ–¼è¡Œå‹•é›£åº¦ï¼Œæœ€å¤šä¸è¶…éä½¿ç”¨éª°å­çš„9/10
                                        "diceType": "d20", // æ“²éª°é¡å‹ï¼Œä¾‹å¦‚'d6', 'd10', 'd20','d50','d60','d100'
                                        "skill": "str", // (å¯é¸) ç›¸é—œå±¬æ€§ï¼Œä¾‹å¦‚ 'str', 'dex', 'int','con', 'san','cha'
                                        "damageRoll": "d6" // (å¯é¸) æ“²éª°å‚·å®³ï¼Œä¾‹å¦‚ 'd6', 'd10', 'd20','d50','d60','d100'
                                    },
                                    ...
                                ]
                            }
                            æ¯å€‹é¸é …éƒ½å¿…é ˆåŒ…å« text, action, difficulty å’Œ diceTypeã€‚
                            é›£åº¦å€¼æ‡‰è©²æ ¹æ“šè¡Œå‹•çš„åˆç†æ€§è€Œå®šã€‚
                            æ•…äº‹æ•˜è¿°å’Œé¸é …éƒ½å¿…é ˆèˆ‡éŠæˆ²é¢¨æ ¼ "${gameState.style}" ç›¸ç¬¦ã€‚
                            å¦‚æœç©å®¶çš„è¡Œå‹•æ˜é¡¯æ˜¯è‡´å‘½æˆ–é­¯è½çš„ï¼Œå°‡å…¶é¸é …çš„ 'action' è¨­å®šç‚º 'suicide_end_game'ã€‚
                            ä½ å¿…é ˆç¢ºä¿éŠæˆ²åœ¨ ${gameState.gameLength} å›åˆå…§çµæŸï¼Œè«‹æ ¹æ“šç›®å‰ ${gameState.currentTurn} / ${gameState.gameLength} çš„å›åˆæ•¸ä¾†ç°¡åŒ–æˆ–æ¨é€²æ•…äº‹ã€‚
                            å¦‚æœç•¶å‰å›åˆæ•¸åˆ°é” ${gameState.gameLength}ï¼Œè«‹ç”¢ç”Ÿä¸€å€‹ç¸½çµæ€§çš„çµå±€æ•˜è¿°ã€‚ä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è§£é‡‹ï¼Œåªéœ€æä¾› JSON ç‰©ä»¶ã€‚`
                        }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const response = await fetch(`${API_URL}${currentApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API éŒ¯èª¤å›æ‡‰ (ç‹€æ…‹ç¢¼:", response.status, "):", errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText || 'No response body'}`);
                }
                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("API å›æ‡‰ä¸­æ‰¾ä¸åˆ° JSON è³‡æ–™ã€‚");
                }
                const storyResponse = JSON.parse(jsonText);
                return storyResponse;

            } catch (error) {
                console.error(`Fetch attempt ${retries + 1} failed:`, error);
                if (retries < maxRetries - 1) {
                    await delay(Math.pow(2, retries) * 1000);
                } else {
                    throw error;
                }
                retries++;
            }
        }
        return null;
    }
    
    async function generateCharacter(style) {
        const prompt = `æ ¹æ“šä¸€å€‹ "${style}" çš„å†’éšªé¢¨æ ¼ï¼Œç”¢ç”Ÿä¸€å€‹è§’è‰²çš„åå­—ã€ç°¡çŸ­èƒŒæ™¯æ•…äº‹ã€ä¸€å€‹ç‰¹æ®Šèƒ½åŠ›å’ŒåŸºç¤å±¬æ€§ã€‚ç¸½å±¬æ€§é»æ•¸ç‚º ${totalPoints}ï¼Œåˆ†åˆ¥åˆ†é…çµ¦åŠ›é‡(str)ã€æ•æ·(dex)ã€æ™ºåŠ›(int)ã€é«”åŠ›(con)ã€ç†æ™º(san)å’Œé­…åŠ›(cha)ã€‚å±¬æ€§é»æ•¸å¿…é ˆæ˜¯æ•´æ•¸ã€‚HP å¿…é ˆæ˜¯ 50ã€‚å›è¦†çš„ JSON æ ¼å¼ç‚º: 
            {"name": "è§’è‰²åç¨±", "background": "èƒŒæ™¯æ•…äº‹", "ability": "ç‰¹æ®Šèƒ½åŠ›èˆ‡è§¸ç™¼æ¢ä»¶(ä¾‹å¦‚:[å¤©ç”Ÿç¥åŠ›]: é©ç”¨æ–¼åŠ›é‡æª¢å®šï¼Œæ“²éª° D20ï¼Œçµæœ 18-20 æ™‚è§¸ç™¼ã€‚æ•ˆæœï¼šæˆåŠŸé›£åº¦é™ä½ 5ã€‚)", "hp": 50, "str": 4, "dex": 4, "int": 4, "con": 4, "san": 4, "cha": 4}ã€‚è«‹ç¢ºä¿ç”Ÿæˆçš„èƒ½åŠ›æ ¼å¼ç¬¦åˆç¯„ä¾‹ã€‚`;
        try {
            const currentApiKey = gameState.geminiApiKey; // Use embedded API key
            if (!currentApiKey || currentApiKey === 'YOUR_GEMINI_API_KEY') { 
                console.error("Gemini API é‡‘é‘°éºå¤±æˆ–æœªè¨­å®šã€‚è«‹ç¢ºèªå·²åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šé‡‘é‘°ã€‚");
                showMessage("Gemini API é‡‘é‘°éºå¤±æˆ–æœªè¨­å®šã€‚è«‹ç¢ºèªå·²åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šé‡‘é‘°ã€‚", 'error');
                throw new Error("Gemini API é‡‘é‘°éºå¤±ã€‚");
            }

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{
                        text: `ä½ æ˜¯ä¸€å€‹è§’è‰²å‰µå»ºåŠ©æ‰‹ï¼Œæ ¹æ“šæä¾›çš„é¢¨æ ¼ç”¢ç”Ÿè§’è‰²å±¬æ€§ã€‚ä½ çš„å›ç­”å¿…é ˆæ˜¯å–®ä¸€çš„ JSON ç‰©ä»¶ï¼Œæ ¼å¼ç‚º:
                        {
                            "name": "è§’è‰²åç¨±",
                            "background": "èƒŒæ™¯æ•…äº‹",
                            "ability": "ç‰¹æ®Šèƒ½åŠ›èˆ‡è§¸ç™¼æ¢ä»¶(ä¾‹å¦‚:[å¤©ç”Ÿç¥åŠ›]: é©ç”¨æ–¼åŠ›é‡æª¢å®šï¼Œæ“²éª° D20ï¼Œçµæœ 18-20 æ™‚è§¸ç™¼ã€‚æ•ˆæœï¼šæˆåŠŸé›£åº¦é™ä½ 5ã€‚)",
                            "hp": 50,
                            "str": 0,
                            "dex": 0,
                            "int": 0,
                            "con": 0,
                            "san": 0,
                            "cha": 0
                        }
                        è«‹ç¢ºä¿ str + dex + int + con + san + cha = ${totalPoints}ï¼Œä¸” hp = 50ã€‚
                        ä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è§£é‡‹ï¼Œåªéœ€æä¾› JSON ç‰©ä»¶ã€‚`
                    }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            const response = await fetch(`${API_URL}${currentApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(jsonText);
        } catch (error) {
            console.error("ç”Ÿæˆè§’è‰²å¤±æ•—:", error);
            showMessage(`ç”Ÿæˆè§’è‰²å¤±æ•—: ${error.message}`, 'error');
            return null;
        }
    }

    async function suggestAttributeForCustomAction(actionText) {
        const currentApiKey = gameState.geminiApiKey; // Use embedded API key
        if (!currentApiKey || currentApiKey === 'YOUR_GEMINI_API_KEY') {
            console.error("Gemini API é‡‘é‘°éºå¤±æˆ–æœªè¨­å®šã€‚");
            return { skill: null, reason: "API é‡‘é‘°éºå¤±" };
        }

        const prompt = `åˆ†æä»¥ä¸‹è¡Œå‹•ä¸¦å»ºè­°æœ€é©åˆçš„å±¬æ€§(str, dex, int, con, san, cha)ä¾†é€²è¡Œæª¢å®šã€‚å›è¦†çš„ JSON æ ¼å¼ç‚º: {"skill": "str", "reason": "å»ºè­°ç†ç”±"}ã€‚è¡Œå‹•æè¿°ï¼š"${actionText}"`;
        try {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{
                        text: `ä½ æ˜¯ä¸€å€‹éŠæˆ²åŠ©æ‰‹ï¼Œæ ¹æ“šè¡Œå‹•æè¿°å»ºè­°æœ€ç›¸é—œçš„å±¬æ€§ã€‚å›è¦†å¿…é ˆæ˜¯å–®ä¸€çš„ JSON ç‰©ä»¶ï¼Œæ ¼å¼ç‚º:
                        {"skill": "str", "reason": "å»ºè­°ç†ç”±"}
                        è«‹å¾ str, dex, int, con, san, cha ä¸­é¸æ“‡ä¸€å€‹å±¬æ€§ã€‚
                        ä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–è§£é‡‹ï¼Œåªéœ€æä¾› JSON ç‰©ä»¶ã€‚`
                    }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                }
            };

            const response = await fetch(`${API_URL}${currentApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("API éŒ¯èª¤å›æ‡‰ (å±¬æ€§å»ºè­°):", errorText);
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText || 'No response body'}`);
            }
            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return JSON.parse(jsonText);
        } catch (error) {
            console.error("å±¬æ€§å»ºè­°å¤±æ•—:", error);
            return { skill: null, reason: `å±¬æ€§å»ºè­°å¤±æ•—: ${error.message}` };
        }
    }

    async function generateNextStory(playerAction, success) {
        let prompt;
        if (gameState.currentTurn > gameState.gameLength) { 
            prompt = `ç©å®¶é¸æ“‡äº† "${playerAction}"ã€‚éŠæˆ²å›åˆå·²çµæŸã€‚è«‹æ ¹æ“šç›®å‰æ•…äº‹ç°¡æ½”åœ°å¯«ä¸€å€‹ç¸½çµæ€§çš„çµå±€ã€‚`;
        } else {
            const actionResult = success ? "æˆåŠŸ" : "å¤±æ•—";
            prompt = `ç©å®¶é¸æ“‡äº† "${playerAction}"ï¼Œä¸¦ä¸”è¡Œå‹•çµæœç‚º "${actionResult}"ã€‚ç¹¼çºŒæ•…äº‹ã€‚è«‹ç¢ºä¿æ•…äº‹é€²åº¦ç¬¦åˆç•¶å‰ ${gameState.currentTurn} / ${gameState.gameLength} å›åˆã€‚`;
        }

        try {
            const storyResponse = await callGeminiApi(prompt);
            if (!storyResponse || !storyResponse.narrative) {
                throw new Error("API å›æ‡‰ç„¡æ•ˆæˆ–æ•…äº‹å…§å®¹éºå¤±ã€‚");
            }
            let narrative = storyResponse.narrative;
            if (narrative.length > 300) {
                narrative = narrative.substring(0, 300) + '...';
            }

            addStoryEntry({ type: "event", content: escapeHtml(narrative) });
            gameState.currentEvent = { options: storyResponse.options };

            if (gameState.currentTurn > gameState.gameLength) {
                 endGame();
            }

        } catch (error) {
            console.error("å¾ŒçºŒæ•…äº‹ç”Ÿæˆå¤±æ•—:", error);
            addStoryEntry({ type: "narration", content: `ç„¡æ³•ç¹¼çºŒå†’éšªã€‚éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}ã€‚ä½ æ„Ÿåˆ°ä¸€é™£èŒ«ç„¶ã€‚` });
            gameState.currentEvent = {
                options: [] 
            };
        } finally {
            gameState.loadingStory = false;
            renderActionOptions(); 
            renderStoryLog();
        }
    }

    async function generateInitialStory() {
        if (gameState.loadingStory) return;

        addStoryEntry({ type: "narration", content: `æ­¡è¿ï¼Œ${gameState.name}ã€‚ä½ çš„å†’éšªé¢¨æ ¼æ˜¯ ${gameState.style}ã€‚` });
        addStoryEntry({ type: "narration", content: "æ­£åœ¨ç‚ºä½ ç”Ÿæˆåˆå§‹å†’éšªæ•…äº‹..." });

        gameState.loadingStory = true;
        elements.actionPrompt.textContent = "è™•ç†ä¸­...";
        gameState.currentEvent = { options: [] }; 
        renderActionOptions(); 
        renderStoryLog(); // Show loading animation

        const prompt = `ä»¥ ${gameState.style} é¢¨æ ¼ï¼Œç‚ºè§’è‰² ${gameState.name} ç”¢ç”Ÿä¸€å€‹åˆå§‹å†’éšªå ´æ™¯ã€‚æ•…äº‹å¿…é ˆåœ¨ ${gameState.gameLength} å›åˆå…§çµæŸï¼Œè«‹å¾ç¾åœ¨é–‹å§‹ç‚ºæ­¤åšé‹ªé™³ã€‚`;
        try {
            const storyResponse = await callGeminiApi(prompt);
            if (!storyResponse || !storyResponse.narrative) {
                throw new Error("API å›æ‡‰ç„¡æ•ˆæˆ–æ•…äº‹å…§å®¹éºå¤±ã€‚");
            }
            let narrative = storyResponse.narrative;
            if (narrative.length > 300) {
                narrative = narrative.substring(0, 300) + '...';
            }

            addStoryEntry({ type: "event", content: escapeHtml(narrative) });
            gameState.currentEvent = { options: storyResponse.options };
        } catch (error) {
            console.error("åˆå§‹æ•…äº‹ç”Ÿæˆå¤±æ•—:", error);
            addStoryEntry({ type: "narration", content: `ç„¡æ³•å•Ÿå‹•å†’éšªã€‚éŒ¯èª¤: ${error.message || 'æœªçŸ¥éŒ¯èª¤'}ã€‚ä½ æ„Ÿåˆ°ä¸€é™£èŒ«ç„¶ã€‚` });
            gameState.currentEvent = {
                options: [] 
            };
        } finally {
            gameState.loadingStory = false;
            renderActionOptions(); 
            renderStoryLog();
        }
    }
    
    function updatePointsLeft() {
        let total = 0;
        statInputs.forEach(id => {
            if (elements[id]) { // Added check
                total += parseInt(elements[id].value, 10) || 0;
            }
        });
        const pointsLeft = totalPoints - total;
        if (elements.pointsLeft) elements.pointsLeft.textContent = `å‰©é¤˜é»æ•¸: ${pointsLeft}`; // Added check
        if (pointsLeft < 0) {
            if (elements.pointsLeft) elements.pointsLeft.classList.add('text-red-400'); // Added check
            if (elements.startGameBtn) { // Added check
                elements.startGameBtn.disabled = true;
                elements.startGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        } else {
            if (elements.pointsLeft) elements.pointsLeft.classList.remove('text-red-400'); // Added check
            if (elements.startGameBtn) { // Added check
                elements.startGameBtn.disabled = false;
                elements.startGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    }

    // Function to update the max difficulty for custom action based on selected dice
    function updateMaxDifficulty() {
        if (!elements.customActionDice || !elements.customActionDifficulty) return; // Added check
        const selectedDiceType = elements.customActionDice.value.toLowerCase();
        const maxRoll = diceMap[selectedDiceType];
        if (maxRoll) {
            const newMaxDifficulty = Math.floor(maxRoll * 0.9);
            elements.customActionDifficulty.max = newMaxDifficulty;
            // Ensure current value doesn't exceed new max
            if (parseInt(elements.customActionDifficulty.value, 10) > newMaxDifficulty) {
                elements.customActionDifficulty.value = newMaxDifficulty;
            }
            elements.customActionDifficulty.placeholder = `æœ€å¤§: ${newMaxDifficulty}`;
        } else {
            elements.customActionDifficulty.max = 10; // Default max if diceType is unknown
            elements.customActionDifficulty.placeholder = `æœ€å¤§: 10`;
        }
    }


    async function handleCustomAction() {
        if (!elements.customActionText || !elements.customActionDice || !elements.customActionDifficulty || !elements.aiAttributeSuggestion) return; // Added check
        const customActionText = elements.customActionText.value.trim();
        const customActionDice = elements.customActionDice.value;
        const customActionDifficulty = parseInt(elements.customActionDifficulty.value, 10);

        if (!customActionText) {
            showMessage('è«‹è¼¸å…¥è‡ªè¨‚è¡Œå‹•çš„æè¿°ã€‚', 'error');
            return;
        }

        const maxAllowedDifficulty = Math.floor(diceMap[customActionDice.toLowerCase()] * 0.9);
        if (isNaN(customActionDifficulty) || customActionDifficulty < 1 || customActionDifficulty > maxAllowedDifficulty) {
            showMessage(`è¡Œå‹•é›£åº¦å¿…é ˆæ˜¯ 1 åˆ° ${maxAllowedDifficulty} ä¹‹é–“çš„æ•¸å­— (æ‰€é¸éª°å­é»æ•¸çš„ 9/10)ã€‚`, 'error');
            return;
        }

        const skillToUse = gameState.aiSuggestedCustomSkill || null; 

        const customOption = {
            text: customActionText,
            action: 'custom_action',
            difficulty: customActionDifficulty,
            diceType: customActionDice,
            skill: skillToUse 
        };

        elements.customActionText.value = '';
        if (elements.customActionDice) elements.customActionDifficulty.value = Math.floor(diceMap[elements.customActionDice.value.toLowerCase()] * 0.9 / 2); // Added check for customActionDice
        if (elements.aiAttributeSuggestion) elements.aiAttributeSuggestion.textContent = 'AI å»ºè­°å±¬æ€§: å¾…åˆ†æ'; // Added check
        gameState.aiSuggestedCustomSkill = null;

        await handleAction(customOption);
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    // --- JSON File Management Functions ---
    function downloadGameState() {
        const filename = `${gameState.name || 'æœªå‘½åè§’è‰²'}_TRPG_Save.json`;
        const jsonStr = JSON.stringify(gameState, null, 2); // Pretty print JSON

        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage('éŠæˆ²è¨˜éŒ„å·²ä¸‹è¼‰ï¼');
    }

    function uploadGameState(event) {
        const file = event.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const loadedState = JSON.parse(e.target.result);
                // Basic validation
                if (loadedState && loadedState.name && loadedState.hp !== undefined) {
                    gameState = loadedState;
                    // API key is embedded, no need to update input field.
                    showGamePage(); 
                    renderCharacterSheet();
                    renderStoryLog();
                    renderActionOptions();
                    showMessage('éŠæˆ²è¨˜éŒ„å·²ä¸Šå‚³æˆåŠŸï¼');
                } else {
                    showMessage('ä¸Šå‚³çš„éŠæˆ²è¨˜éŒ„æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºã€‚', 'error');
                }
            } catch (error) {
                console.error('è§£æä¸Šå‚³æª”æ¡ˆå¤±æ•—:', error);
                showMessage(`è§£æä¸Šå‚³æª”æ¡ˆå¤±æ•—: ${error.message}`, 'error');
            }
        };
        reader.readAsText(file);
    }

    // Initialize the game
    window.onload = async () => {
        // Populate the global elements object
        elements = {
            setupPage: document.getElementById('setup-page'),
            characterCreationPage: document.getElementById('character-creation-page'),
            gamePage: document.getElementById('game-page'),
            storyColumn: document.getElementById('story-column'),
            nextToCharBtn: document.getElementById('next-to-char-btn'),
            startGameBtn: document.getElementById('start-game-btn'),
            
            gameStyleSelect: document.getElementById('game-style-select'),
            customStyleInputContainer: document.getElementById('custom-style-input-container'),
            customStyleInput: document.getElementById('custom-style-input'),
            gameTurns: document.getElementById('game-turns'),
            difficultyRadios: document.getElementsByName('difficulty'),

            charName: document.getElementById('char-name'),
            charBackground: document.getElementById('char-background'),
            charAbilityInput: document.getElementById('char-ability-input'), // Updated ID
            pointsLeft: document.getElementById('points-left'),
            
            'char-str': document.getElementById('char-str'),
            'char-dex': document.getElementById('char-dex'),
            'char-int': document.getElementById('char-int'),
            'char-con': document.getElementById('char-con'),
            'char-san': document.getElementById('char-san'),
            'char-cha': document.getElementById('char-cha'),
            
            displayName: document.getElementById('display-name'),
            displayStyle: document.getElementById('display-style'),
            displayCurrentTurn: document.getElementById('display-current-turn'), 
            displayHpValue: document.getElementById('display-hp-value'),
            hpBar: document.getElementById('hp-bar'),
            displayStrValue: document.getElementById('display-str-value'),
            displayDexValue: document.getElementById('display-dex-value'),
            displayIntValue: document.getElementById('display-int-value'),
            displayConValue: document.getElementById('display-con-value'),
            displaySanValue: document.getElementById('display-san-value'),
            displayChaValue: document.getElementById('display-cha-value'),
            displayBackground: document.getElementById('display-background'),
            displayAbilityContainer: document.getElementById('display-ability-container'), // New element
            displayAbilityText: document.getElementById('display-ability-text'), // New element
            useAbilityBtn: document.getElementById('use-ability-btn'), // New element
            abilityCooldownDisplay: document.getElementById('ability-cooldown-display'), // New element
            
            storyLog: document.getElementById('story-log'),
            actionPrompt: document.getElementById('action-prompt'),
            aiActionOptionsContainer: document.getElementById('ai-action-options-container'), // New element for AI options

            defaultActionsGroup: document.getElementById('default-actions-group'), // New element for default actions
            defaultActionForward: document.getElementById('default-action-forward'),
            defaultActionObserve: document.getElementById('default-action-observe'),
            defaultActionRest: document.getElementById('default-action-rest'),

            customActionGroup: document.getElementById('custom-action-group'), // New element for custom actions
            customActionText: document.getElementById('custom-action-text'),
            customActionDice: document.getElementById('custom-action-dice'),
            customActionDifficulty: document.getElementById('custom-action-difficulty'),
            executeCustomActionBtn: document.getElementById('execute-custom-action-btn'),
            aiAttributeSuggestion: document.getElementById('ai-attribute-suggestion'),

            // Google Auth Elements (all removed, but keeping placeholder for elements object structure)
            userInfo: document.getElementById('user-info'), // This element remains, but will be empty
            driveSavesList: document.getElementById('drive-saves-list'),
            driveSavesContainer: document.getElementById('drive-saves-container'),
        };

        // --- Event Listeners ---
        if (elements.gameStyleSelect) { 
            elements.gameStyleSelect.addEventListener('change', (e) => {
                if (e.target.value === 'è‡ªå®šç¾©') {
                    if (elements.customStyleInputContainer) elements.customStyleInputContainer.classList.remove('hidden');
                } else {
                    if (elements.customStyleInputContainer) elements.customStyleInputContainer.classList.add('hidden');
                }
            });
        }

        statInputs.forEach(id => {
            if (elements[id]) { 
                elements[id].addEventListener('input', updatePointsLeft);
            }
        });
        updatePointsLeft();

        // New event listener for custom dice selection to update max difficulty
        if (elements.customActionDice) { 
            elements.customActionDice.addEventListener('change', updateMaxDifficulty);
        }
        // Initial call to set max difficulty based on default dice
        updateMaxDifficulty();

        if (elements.nextToCharBtn) { 
            elements.nextToCharBtn.addEventListener('click', async () => {
                let selectedStyle = elements.gameStyleSelect ? elements.gameStyleSelect.value : ''; 
                if (selectedStyle === 'è‡ªå®šç¾©') {
                    selectedStyle = elements.customStyleInput ? elements.customStyleInput.value : ''; 
                    if (!selectedStyle.trim()) {
                        showMessage('è«‹è¼¸å…¥è‡ªå®šç¾©ä¸–ç•Œè§€æˆ–é¸æ“‡ä¸€å€‹é è¨­é¢¨æ ¼ã€‚', 'error');
                        return;
                    }
                }
                
                gameState.style = selectedStyle;
                gameState.gameLength = parseInt(elements.gameTurns ? elements.gameTurns.value : '6', 10); 
                gameState.currentTurn = 1; 
                gameState.difficulty = Array.from(elements.difficultyRadios).find(radio => radio.checked)?.value || "medium"; 
                
                showCharacterCreationPage();
                
                const loadingMessage = "æ­£åœ¨ç‚ºä½ ç”Ÿæˆè§’è‰²èƒŒæ™¯æ•…äº‹èˆ‡èƒ½åŠ›...è«‹ç¨å€™";
                if (elements.charName) elements.charName.placeholder = loadingMessage; 
                if (elements.charBackground) elements.charBackground.placeholder = loadingMessage; 
                if (elements.charAbilityInput) elements.charAbilityInput.placeholder = loadingMessage; // Updated ID
                
                const newCharacter = await generateCharacter(gameState.style);
                if (newCharacter) {
                    if (elements.charName) elements.charName.value = newCharacter.name; 
                    if (elements.charBackground) elements.charBackground.value = newCharacter.background; 
                    if (elements.charAbilityInput) elements.charAbilityInput.value = newCharacter.ability; // Updated ID
                    
                    if (elements['char-str']) elements['char-str'].value = newCharacter.str; 
                    if (elements['char-dex']) elements['char-dex'].value = newCharacter.dex; 
                    if (elements['char-int']) elements['char-int'].value = newCharacter.int; 
                    if (elements['char-con']) elements['char-con'].value = newCharacter.con; 
                    if (elements['char-san']) elements['char-san'].value = newCharacter.san; 
                    if (elements['char-cha']) elements['char-cha'].value = newCharacter.cha; 
                    updatePointsLeft();
                } else {
                    if (elements.charName) elements.charName.placeholder = "ç”Ÿæˆå¤±æ•—"; 
                    if (elements.charBackground) elements.charBackground.placeholder = "ç”Ÿæˆå¤±æ•—"; 
                    if (elements.charAbilityInput) elements.charAbilityInput.placeholder = "ç”Ÿæˆå¤±æ•—"; // Updated ID
                }
            });
        }

        if (elements.startGameBtn) { 
            elements.startGameBtn.addEventListener('click', async () => {
                let currentAllocatedPoints = 0;
                statInputs.forEach(id => {
                    if (elements[id]) { 
                        currentAllocatedPoints += parseInt(elements[id].value, 10) || 0;
                    }
                });
                if (currentAllocatedPoints !== totalPoints) { // Modified: Check against new totalPoints
                    showMessage(`è«‹åˆ†é…å®Œæ‰€æœ‰ ${totalPoints} é»å±¬æ€§é»æ•¸ã€‚ç›®å‰é‚„æœ‰ ${totalPoints - currentAllocatedPoints} é»æœªåˆ†é…ã€‚`, 'error');
                    return;
                }
                
                gameState.name = elements.charName ? elements.charName.value : ''; 
                gameState.background = elements.charBackground ? elements.charBackground.value : ''; 
                gameState.ability = elements.charAbilityInput ? elements.charAbilityInput.value : ''; // Updated ID
                gameState.str = parseInt(elements['char-str'] ? elements['char-str'].value : '0', 10) || 0; 
                gameState.dex = parseInt(elements['char-dex'] ? elements['char-dex'].value : '0', 10) || 0; 
                gameState.int = parseInt(elements['char-int'] ? elements['char-int'].value : '0', 10) || 0; 
                gameState.con = parseInt(elements['char-con'] ? elements['char-con'].value : '0', 10) || 0; 
                gameState.san = parseInt(elements['char-san'] ? elements['char-san'].value : '0', 10) || 0; 
                gameState.cha = parseInt(elements['char-cha'] ? elements['char-cha'].value : '0', 10) || 0; 

                if (!gameState.name.trim() || !gameState.background.trim() || !gameState.ability.trim()) {
                    showMessage('è§’è‰²åç¨±ã€èƒŒæ™¯æ•…äº‹å’Œç‰¹æ®Šèƒ½åŠ›éƒ½ä¸èƒ½ç‚ºç©ºã€‚', 'error');
                    return;
                }

                showGamePage();
                renderCharacterSheet();
                await generateInitialStory();
            });
        }

        if (elements.defaultActionForward) { 
            elements.defaultActionForward.addEventListener('click', () => {
                handleAction({ text: "æŒçºŒå‰é€²", action: "keep_moving", difficulty: 5, diceType: 'd6', skill: 'con' });
            });
        }
        if (elements.defaultActionObserve) { 
            elements.defaultActionObserve.addEventListener('click', () => {
                handleAction({ text: "è§€å¯Ÿæƒ…æ³", action: "observe", difficulty: 7, diceType: 'd10', skill: 'int' });
            });
        }
        if (elements.defaultActionRest) { 
            elements.defaultActionRest.addEventListener('click', () => {
                handleAction({ text: "åŸåœ°ä¼‘æ¯", action: "rest", difficulty: 3, diceType: 'd6', skill: 'con' });
            });
        }

        if (elements.executeCustomActionBtn) { 
            elements.executeCustomActionBtn.addEventListener('click', handleCustomAction);
        }

        if (elements.customActionText) { 
            elements.customActionText.addEventListener('input', debounce(async () => {
                const actionText = elements.customActionText ? elements.customActionText.value.trim() : ''; 
                if (actionText.length > 5) {
                    if (elements.aiAttributeSuggestion) elements.aiAttributeSuggestion.textContent = 'AI å»ºè­°å±¬æ€§: åˆ†æä¸­...'; 
                    const suggestion = await suggestAttributeForCustomAction(actionText);
                    if (suggestion && suggestion.skill) {
                        gameState.aiSuggestedCustomSkill = suggestion.skill;
                        if (elements.aiAttributeSuggestion) elements.aiAttributeSuggestion.textContent = `AI å»ºè­°å±¬æ€§: ${attributeMapping[suggestion.skill]} (åŸºæ–¼ï¼š${suggestion.reason})`; 
                    } else {
                        gameState.aiSuggestedCustomSkill = null;
                        if (elements.aiAttributeSuggestion) elements.aiAttributeSuggestion.textContent = 'AI å»ºè­°å±¬æ€§: å¾…åˆ†æ'; 
                    }
                } else {
                    gameState.aiSuggestedCustomSkill = null;
                    if (elements.aiAttributeSuggestion) elements.aiAttributeSuggestion.textContent = 'AI å»ºè­°å±¬æ€§: å¾…åˆ†æ'; 
                }
            }, 500));
        }

        // æ–°å¢ç‰¹æ®Šèƒ½åŠ›æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨
        if (elements.useAbilityBtn) {
            elements.useAbilityBtn.addEventListener('click', handleAbilityUse);
        }

        // JSON File Management Handlers
        if (elements.downloadGameStateBtn) { 
            elements.downloadGameStateBtn.addEventListener('click', downloadGameState);
        }
        if (elements.uploadGameStateBtn) { 
            elements.uploadGameStateBtn.addEventListener('click', () => {
                if (elements.uploadGameStateInput) elements.uploadGameStateInput.click(); 
            });
        }
        if (elements.uploadGameStateInput) { 
            elements.uploadGameStateInput.addEventListener('change', uploadGameState);
        }

        showSetupPage();
    };
</script>

</body>
</html>

